<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="global.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito+Sans:opsz@6..12&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="components/checkout-container.css">
    <link rel="stylesheet" href="components/nav.css">
    <link rel="stylesheet" href="components/tab.css">
    <link rel="stylesheet" href="components/order.css">

    <title>Transparent Checkout SDK</title>
    
    <!-- Importa el SDK de Clip -->
    <script src="https://sdk.clip.mx/js/clip-sdk.js"></script>

    <script type="module" src="js/tab.js"></script>
  </head>
  <body>
    
    <main>
      <section class="checkout-section">
        <nav>
          <ul>
            <li>
              <a href="index.html">
                <figure>
                  <img src="assets/logo-clip.png" alt="">
                </figure>
                SDK Checkout Transparent - API Checkout Redirect
              </a>
            </li>
          </ul>
        </nav>

        <div class="tab-options">
          <span>Payment method</span>
          <div class="tab">
            <input id="card" type="radio" name="payment-method" checked>
            <label for="card">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g clip-path="url(#clip0_6_12263)">
                <path d="M20 4H4C2.89 4 2.01 4.89 2.01 6L2 18C2 19.11 2.89 20 4 20H20C21.11 20 22 19.11 22 18V6C22 4.89 21.11 4 20 4ZM20 18H4V12H20V18ZM20 8H4V6H20V8Z" fill="#323232"/>
                </g>
                <defs>
                <clipPath id="clip0_6_12263">
                <rect width="24" height="24" fill="white"/>
                </clipPath>
                </defs>
              </svg>
              Card
            </label>
            <input id="cash" type="radio" name="payment-method">
            <label for="cash">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g clip-path="url(#clip0_6_9490)">
                <path d="M11.8001 10.9C9.53007 10.31 8.80007 9.7 8.80007 8.75C8.80007 7.66 9.81007 6.9 11.5001 6.9C13.2801 6.9 13.9401 7.75 14.0001 9H16.2101C16.1401 7.28 15.0901 5.7 13.0001 5.19V3H10.0001V5.16C8.06007 5.58 6.50007 6.84 6.50007 8.77C6.50007 11.08 8.41007 12.23 11.2001 12.9C13.7001 13.5 14.2001 14.38 14.2001 15.31C14.2001 16 13.7101 17.1 11.5001 17.1C9.44007 17.1 8.63007 16.18 8.52007 15H6.32007C6.44007 17.19 8.08007 18.42 10.0001 18.83V21H13.0001V18.85C14.9501 18.48 16.5001 17.35 16.5001 15.3C16.5001 12.46 14.0701 11.49 11.8001 10.9Z" fill="#323232"/>
                </g>
                <defs>
                <clipPath id="clip0_6_9490">
                <rect width="24" height="24" fill="white"/>
                </clipPath>
                </defs>
              </svg>
              Cash
            </label>
          </div>
        </div>

        <div id="checkout-container" class="content checkout-container">
          <div class="form-payment">
            <span>Customer information</span>
            <!--<h1>Transparent Checkout SDK</h1>-->
            <!-- Formulario para obtener el token de la tarjeta -->
            <form id="payment-form">
              <div id="checkout"></div>
              <button id="submit">
                <figure>
                  <img src="assets/logo-clip.png" alt="Logotipo Clip">
                </figure>
                Pagar con Clip
              </button>
              <p id="cardTokenId"></p>
            </form>
          </div>
      
          <h2>
            <div id="status-message" style="display:none;"></div>
          </h2>
          <div id="3ds-iframe-container" style="display:none;"></div>
        </div>

        <div id="cash-container" class="content cash-container">
          <iframe id="iframe-cash" class="iframe-cash" frameborder="0" allow="payment"></iframe>
        </div>
      </section>

      <section class="receipt-section">
        <div class="receipt-amount">
          <span class="spn-total">Total amount</span>
          <h2>$ 1 MXN</h2>
          <span class="spn-payment">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <g clip-path="url(#clip0_6_16196)">
              <path d="M18 8H17V6C17 3.24 14.76 1 12 1C9.24 1 7 3.24 7 6V8H6C4.9 8 4 8.9 4 10V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V10C20 8.9 19.1 8 18 8ZM9 6C9 4.34 10.34 3 12 3C13.66 3 15 4.34 15 6V8H9V6ZM18 20H6V10H18V20ZM12 17C13.1 17 14 16.1 14 15C14 13.9 13.1 13 12 13C10.9 13 10 13.9 10 15C10 16.1 10.9 17 12 17Z" fill="#00B85C"/>
              </g>
              <defs>
              <clipPath id="clip0_6_16196">
              <rect width="24" height="24" fill="white"/>
              </clipPath>
              </defs>
            </svg>
            Secure Payment
          </span>
        </div>
        <hr>
        <div class="order">
          <span>Order summary</span>
          <div class="product">
            <div>
              <span class="spn-product">
                <figure>
                  <img src="assets/nike.png" alt="Tenis Nike">
                </figure>
                Nike Dunk High Retro
              </span>
              <span class="spn-product">$ 1533.86</span>
            </div>
            <span>Size US 7</span>
          </div>
          <hr>
          <div class="subtotal">
            <div>
              <span>Subtotal</span>
              <span>$ 1533.86</span>
            </div>
            <div>
              <span>Comision clip + Tax</span>
              <span>$ 66.91</span>
            </div>
          </div>
          <hr>
          <div class="total">
            <span class="spn-total">Total</span>
            <span class="spn-total">$ 1600.77</span>
          </div>
        </div>        
      </div>
      </section>
    </main>
    <dialog id="3ds-iframe-container-2" class="modal">
      <iframe>
        
      </iframe>
    </dialog>
    

    <!-- Autenticación -->
    <script>
      const API_KEY = "Tu_Basic64 " //Aquí va tu Basic64, no es necesario agregar nada más
      const token = "Tu_Basic";
      const amount = 0.01;
      const amountRegex= amount.toFixed(2);

      // Inicializa el SDK de Clip con la API Key proporcionada
      const clip = new ClipSDK(API_KEY);
      
      // Verifica si la API Key ha sido ingresada correctamente
      if (API_KEY == "XXXXXXXXXX") {
        alert("Favor de ingresar tu API Key (https://dashboard.developer.clip.mx/applications)");
      }

      // Crea un elemento tarjeta con el SDK de Clip
      const card = clip.element.create("Card", {
        theme: "light",
        locale: "es",
        paymentAmount: amountRegex, //Este valor es lo que pretendes cobrar
        terms: {
          enabled: true, //Habilitas los installments
        },
      });
      card.mount("checkout");

      // Maneja el evento de envío del formulario
      document.querySelector("#payment-form").addEventListener("submit", async (event) => {
        event.preventDefault();       
        try {
          
          // Obtén el token de la tarjeta
          const cardToken = await card.cardToken();
          const preventionData = await card.preventionData();
          // Guarda el Card Token ID de la tarjeta en una constante
          const cardTokenID = cardToken.id;
          console.log("Card Token ID:", cardTokenID);
          console.log(card.cardholderData());


          const cardholderData = card.cardholderData().then((objectData) => {
            objectData.firstName;
            objectData.lastName;

            return objectData;
          });

          const name = await cardholderData;
          console.log(name.firstName, name.lastName)

          const installments = card.installments().then((installment) => {
            return installment;    
          });

          if (cardTokenID) {
            console.log("Llamando a ApiPayment con el token:", token, "y cardTokenID:", cardTokenID, cardToken, amountRegex, preventionData.user_agent, preventionData.session_id); 
            let res = await ApiPayment(token, cardTokenID, amountRegex, preventionData.user_agent, preventionData.session_id);
            console.log(res);

            //Identificar si un pago requiere validación 3DS
            if(res.status == 'pending' && res.status_detail.code == "PE-3DS01" && res.status_detail.message == "Waiting 3ds"){
              console.log('3DS Active');

              console.log(res)
              show3DSIframe(res.pending_action.url, res.id);
            }
          } else {
            console.error("Card Token ID no es válido");
          }

        } catch (error) {
          
          // Maneja errores durante la tokenización de la tarjeta
          switch (error.code) {
            case "CL2200":
            case "CL2290":
              alert("Error: " + error.message);
              throw error;
              break;
            case "AI1300":
              console.log("Error: ", error.message);
              break;
            default:
              break;
          }
        }        
      });

    function show3DSIframe(url_3ds, paymentId){
        console.log(url_3ds, paymentId)
        const dialog = document.getElementById("3ds-iframe-container-2");
       
          //dialog.close = false;
          dialog.showModal();
          console.log("entro")
          dialog.innerHTML = 
          ` 
            <iframe
                title="cybersource3Ds" 
                src="${url_3ds}" 
                data-testid="cybersource3Ds-iframe"
              >
            </iframe>
          `;

          window.addEventListener("message", (event) => {
            if (event.origin !== new URL(url_3ds).origin) {
              console.log("returned payment")
              return; // Ignorar mensajes de otros orígenes
            }
            if (event.data?.paymentId) {
              console.log("Returned Payment ID:", paymentId);

              setTimeout(()=>{
                dialog.close();
              }, 5000)
            }
          });
    } 
    

      async function ApiPayment(token, card_token, amountRegex, first_name, last_name, installment, user_agent, session_id) {
          const options = {
            method: 'POST',
            headers: {
              'Authorization': 'Tu_BASIC64
                ',
              'accept': 'application/json', 
              'content-type': 'application/json'
            },
            body: JSON.stringify({
              amount: amountRegex,
              currency: 'MXN',
              description: 'Ejemplo de compra',
              payment_method: {
                token: card_token
              },
              installments: installment,
              customer: {
                first_name: first_name, 
                last_name: last_name,  
                email: "correo@gmail.com",
                phone: "5538611026",
                description: "Gerente de la fábrica de pintura", 
                address:{ 
                    postal_code: "01290",
                    street: "Av Uno",
                    exterior_number: "4",
                    internal_number: "3", 
                    city: "Álvaro Obregón", 
                    country: "México", 
                    state:"Ciudad de México"            
                },
                identification: { 
                    id: "CA3N810503KKKSNGB2", 
                    type: "CURP"
                }        
            },
            prevention_data: {
                customer_type: "returning_buyer",
                submerchant_id:"id 001",
                user_agent: user_agent,
                session_id: session_id,
                device_finger_print_token: session_id,
                request_3ds: true
            },

            metadata: {         
                billing_address: {
                    postal_code: "01290",
                    street: "Av Uno",
                    exterior_number: "4",
                    internal_number: "3", 
                    colony: "Colonia",
                    reference: "Puerta de color negro",
                    city: "Álvaro Obregón", 
                    country: "México", 
                    state:"Ciudad de México" 
                },
                shipping_address: { 
                    postal_code: "01290",
                    street: "Av Uno",
                    exterior_number: "4",
                    internal_number: "3", 
                    colony: "Colonia",
                    reference: "Puerta de color negro",
                    city: "Álvaro Obregón", 
                    country: "México", 
                    state:"Ciudad de México" 
                },     
             },
             source: "txo_clip",
                website: "https://clip.mx",
                webhook_url: "https://smee.io/OzVLmWgJQvtqpX0"
            })
          };
        
          try {
            const response = await fetch('https://api.payclip.com/payments', options);
            const data = await response.json();
            console.log(data);

            return {
              id: data.id,
              pending_action: {
                type: data.pending_action.type,
                url: data.pending_action.url
              },
              status: data.status,
              status_detail: {
                code: data.status_detail.code,
                message: data.status_detail.message
              }
            };
          } catch (err) {
            console.error(err);
          }
      }
      async function checkout(token) {
        const options = {
          method: 'POST',
          headers: {
            'Authorization': 'Tu_Basic',
            'accept': 'application/json', 
            'content-type': 'application/json'
          },
          body: JSON.stringify({
            "amount": 15,
            "currency": "MXN",
            "purchase_description": "ejemplo de compra",
            "redirection_url": {
              "success": "https://www.google.com/",
              "error": "https://www.youtube.com",
              "default": "https://www.youtube.com"
            },
            "custom_payment_options": {
              "payment_method_types": [
                "bank_transfer",
                "cash"
              ]
            }
          })
        };
      
        try {
          const response = await fetch('https://api.payclip.com/v2/checkout', options);
          const data = await response.json();
          console.log(data);
          return data;
        } catch (err) {
          console.error(err);
        }
      }

      const inputCheckout = document.getElementById('cash');
      const iframeCash = document.getElementById('iframe-cash');

      inputCheckout.addEventListener('click', async()=>{
        const link = await checkout('Basic ==');
        console.log(link.payment_request_url);
        iframeCash.src= link.payment_request_url;

      });
    </script>
  </body>
</html>


